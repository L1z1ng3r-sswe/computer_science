аппаратный кеш - не кеш в привычном понимании. кешем называется чтобы хранить данные которые уже были вытянуты из рам и не надо было обратно обращаться тратя больше времени.

есть 4 вида кешей и каждый их них имеет трейдоф по скорости и цене за обьем потому лучше идти дорогостоящие еденицы и самые быстрые держать ближе к ядру, и сделать уровни.
регистры - 64bit (зависит от архитектуры процессора), хранят кешлинии
l1 - 32-64kb
l2 - 256-1mb
l3 - 2-64mb (shared between cores for parralel work)

cacheline - 64-128byte (минимальная единица управления в виртуальной памяти)
ос не может тебе выделить байты, но страницы - пожалуйста.

page - наименьший юнит подгружаемый 4кб

из-за того, что линкед лист разбросан по разным местам в памяти, а подгрузка данных идет по кеш линиям (spatial locality обязателен), линкед лист очень плох в этом плане.
когда программа запускается ей надо время чтобы подгрузить данные из медленной RAM в процессор, при втором запуске эти данные уже есть и когда процессор идет из l1 в l2 он спокойно находит данные. это и называется прогретостью аппаратных кешей.

кеш линия - как защищена и что является оркестратором и что будет если 2 ядра запросят её и как идет работа со страницей и кеш линией. как я понял кеш линия загружается в какой-то кеш. мне кажется модель работы очистки кеша скорее вытесняющая. типа если данные слишком долго находятся там то они просто движутся в конец и затем при достижении конца - затираются. но что происходит при запросе из первого кеша во второй ? копирование или стирание из прошлого места и запись в нижний кеш и как заполняется и вытесняется кеш. верхний кеш и нижний кеш как правильно назвать.

что-за нахуй false sharing

как увидеть кеш-линию для структуры

64 битный процессоры при запуске 32 битных просто срезают себе производительность (регистры 32,а не 64) и поинтеры 32 а не 64

я так и не понял, раз проц по твоим словам подстроился под 64 свои 128 то что мне по итогу делать то... 64 или перейти на 128 ? разница в памяти - 2 раза. надо подумать как-бы.

если регистров не хватает - в очередь (write buffer) на запись в стек (RAM), быстрее чем ждать пока запишется.

нельзя позволить нескольким ядрам работать на одной кешлинии.

если идет только чтение кешлинии (shared), то ядрам разрешен одновременный доступ.
если же ядро хочет записать (write):
Оно должно захватить кеш-линию в Modified
Остальные ядра должны инвалидировать свои копии этой линии (перевести в Invalid)

Оно становится владельцем (Modified)
Остальные ядра не могут её использовать, пока:
не получат её от него (по шине или snooping'у)
либо она не сбросится обратно в RAM

Если второе ядро хочет записать в ту же линию:
Оно делает snoop-запрос
Перетягивает линию, предыдущее ядро сбрасывает кеш (writeback), линия становится Modified у нового владельца

каждая кеш-линия имеет 2–3 контрольных бита состояния. Они находятся:
либо в теговом блоке кеша
либо в Directory (если архитектура NUMA/directory-based)

модифайд - занят
ничего - свободно.

каждое ядро смотрит сначало в методату, меняет ее по мере надобности и только затем копирует кеш линию к себе в локальные кеши.
если другое ядро прибежит и проверив метадату поймет что она занята - он тупо будет ждать (cache line contention или write ownership stall.)

CPU железо имеет эвикшн-таймеры, eviction policies, preemption
→ если ядро слишком долго держит Modified кеш-линию — оно будет вынуждено сбросить или отдать её
Операционная система может прекратить выполнение потока, который держит кеш (через scheduler)
Современные CPU делают write-combining, speculation и out-of-order execution, чтобы смягчить такие затыки

несколько регистров нужно не просто так:
general-purpose (swap operation f.e.)
stack pointer (stack start)
link register (return addr)
program counter (the current instruction)
frame pointer (current frame start)

куда грузится кешлиния и как она вытесняется

кеши л1, л2 и л3 всегда заполнены ? и очищаются они только по мере заполнения?
как заполняется и вытесняются кеши l1, l2, l3

что такое кешлиния и как она выглядит при модифайд. там какой-то определенный диапазон помечен или чо. просто когда берется переменная - кеш линия - это же 128байт начиная с переменной? но тогда как оверлапинг считается
